SELECT     c.fullname AS "Nome do curso",     CONCAT(u.firstname, ' ', u.lastname) AS "Nome completo",     CASE          WHEN cc.id IS NULL THEN 'Não'         WHEN cc.timecompleted > 0 THEN 'Sim'         ELSE 'Não'     END AS "Concluido",     tenant.name AS "Nome do departamento",     ROUND(         CASE              WHEN (                 SELECT COUNT(*)                 FROM mdl_course_modules cm                 WHERE cm.course = c.id                   AND cm.completion > 0             ) = 0 THEN 0             ELSE (                 (SELECT COUNT(*)                  FROM mdl_course_modules_completion cmc                  JOIN mdl_course_modules cm ON cm.id = cmc.coursemoduleid                  WHERE cmc.userid = u.id                    AND cm.course = c.id                    AND cm.completion > 0                    AND cmc.completionstate = 1                 ) * 100                 /                 (SELECT COUNT(*)                  FROM mdl_course_modules cm                  WHERE cm.course = c.id                    AND cm.completion > 0                 )             )         END,     2) AS "Progresso do estudante",     CASE          WHEN cc.timecompleted > 0 THEN TIMESTAMPDIFF(DAY, FROM_UNIXTIME(cc.timeenrolled), FROM_UNIXTIME(cc.timecompleted))         ELSE NULL     END AS "Dias até conclusão",     FROM_UNIXTIME(cc.timecompleted) AS "Data de conclusão",     ROUND(g.finalgrade, 2) AS "Nota final" FROM      mdl_course c LEFT JOIN mdl_enrol e      ON e.courseid = c.id LEFT JOIN mdl_user_enrolments ue      ON ue.enrolid = e.id AND ue.userid <> 1 LEFT JOIN mdl_user u      ON u.id = ue.userid AND u.deleted = 0 LEFT JOIN mdl_course_completions cc      ON cc.course = c.id AND cc.userid = u.id LEFT JOIN mdl_tool_tenant_user ttu      ON ttu.userid = u.id LEFT JOIN mdl_tool_tenant tenant      ON tenant.id = COALESCE(ttu.tenantid, 1) AND tenant.archived = 0 LEFT JOIN mdl_grade_items gi      ON gi.itemtype = 'course' AND gi.courseid = c.id LEFT JOIN mdl_grade_grades g      ON g.userid = u.id AND g.itemid = gi.id WHERE      ue.status = 0     AND u.deleted = 0     AND e.status = 0     AND tenant.name NOT IN ('Senac', 'Saber Senac') ;
