SELECT   base.tenantid AS "Id do Departamento",   base.tenant_name AS "Nome do Departamento",   base.category_name AS "Categoria do Curso",   base.courseid AS "Id do Curso",   base.fullname AS "Nome do Curso",   COUNT(DISTINCT CASE WHEN cc.timecompleted IS NOT NULL AND tu.tenantid = base.tenantid THEN u.id END) AS "Concluídos",   COUNT(DISTINCT CASE WHEN cc.timecompleted IS NULL AND ue.status = 0 AND tu.tenantid = base.tenantid THEN u.id END) AS "Em Andamento",   GREATEST(     0,     COALESCE(ativos.total_ativos, 0) -        COUNT(DISTINCT CASE WHEN cc.timecompleted IS NOT NULL AND tu.tenantid = base.tenantid THEN u.id END) -       COUNT(DISTINCT CASE WHEN cc.timecompleted IS NULL AND ue.status = 0 AND tu.tenantid = base.tenantid THEN u.id END)   ) AS "Não Inscritos" FROM (   SELECT     c.id AS courseid,     c.fullname,     cat.name AS category_name,     t.id AS tenantid,     t.name AS tenant_name   FROM mdl_course c   JOIN mdl_course_categories cat ON cat.id = c.category   JOIN mdl_tool_tenant t ON t.id = 4   WHERE c.category IN (4,5,6,7,37,38,39,44,45,46,47,58,59,60,66,67,68,69,70,71,82,91) ) base LEFT JOIN mdl_enrol e ON e.courseid = base.courseid LEFT JOIN mdl_user_enrolments ue ON ue.enrolid = e.id LEFT JOIN mdl_user u ON u.id = ue.userid AND u.deleted = 0 AND u.suspended = 0 LEFT JOIN mdl_tool_tenant_user tu ON tu.userid = u.id LEFT JOIN mdl_course_completions cc ON cc.userid = u.id AND cc.course = base.courseid LEFT JOIN (   SELECT tu.tenantid, COUNT(DISTINCT u.id) AS total_ativos   FROM mdl_user u   JOIN mdl_tool_tenant_user tu ON u.id = tu.userid   WHERE u.deleted = 0 AND u.suspended = 0   GROUP BY tu.tenantid ) ativos ON ativos.tenantid = base.tenantid GROUP BY   base.tenantid, base.tenant_name,   base.category_name, base.courseid, base.fullname, ativos.total_ativos ORDER BY base.fullname;
