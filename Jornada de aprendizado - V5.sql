SELECT DISTINCT     u.id AS "ID Usuário",     CONCAT(u.firstname, ' ', u.lastname) AS "Nome Usuário",     c.id AS "ID Curso",     c.fullname AS "Nome Curso",     cat.name AS "Categoria do Curso",     COALESCE(NULLIF(TRIM(cfd_carga.value), ''), 'Não Informado') AS "Carga Horária",      CASE m.name         WHEN 'assign' THEN (SELECT a.name FROM mdl_assign a WHERE a.id = cm.instance)         WHEN 'scorm' THEN (SELECT s.name FROM mdl_scorm s WHERE s.id = cm.instance)         WHEN 'feedback' THEN (SELECT f.name FROM mdl_feedback f WHERE f.id = cm.instance)         WHEN 'survey' THEN (SELECT sv.name FROM mdl_survey sv WHERE sv.id = cm.instance)         WHEN 'quiz' THEN (SELECT q.name FROM mdl_quiz q WHERE q.id = cm.instance)         WHEN 'coursecertificate' THEN (SELECT cc2.name FROM mdl_coursecertificate cc2 WHERE cc2.id = cm.instance)         ELSE m.name     END AS "Atividades",      cm.id AS "ID Recurso",      FROM_UNIXTIME(         COALESCE(             (                 SELECT MIN(l1.timecreated)                 FROM mdl_logstore_standard_log l1                 WHERE l1.userid = u.id                   AND l1.contextinstanceid = cm.id                   AND l1.eventname LIKE '%course_module_viewed%'                   AND l1.contextlevel = 70             ),             cmc.timemodified         )     ) AS "Primeiro Acesso Recurso (Data)",      DATE_FORMAT(         FROM_UNIXTIME(             COALESCE(                 (                     SELECT MIN(l1.timecreated)                     FROM mdl_logstore_standard_log l1                     WHERE l1.userid = u.id                       AND l1.contextinstanceid = cm.id                       AND l1.eventname LIKE '%course_module_viewed%'                       AND l1.contextlevel = 70                 ),                 cmc.timemodified             )         ),         '%d/%m/%Y %H:%i:%s'     ) AS "Primeiro Acesso Recurso",      FROM_UNIXTIME(         COALESCE(             (                 SELECT MAX(l2.timecreated)                 FROM mdl_logstore_standard_log l2                 WHERE l2.userid = u.id                   AND l2.contextinstanceid = cm.id                   AND l2.eventname LIKE '%course_module_viewed%'                   AND l2.contextlevel = 70             ),             cmc.timemodified         )     ) AS "Último Acesso Recurso (Data)",      DATE_FORMAT(         FROM_UNIXTIME(             COALESCE(                 (                     SELECT MAX(l2.timecreated)                     FROM mdl_logstore_standard_log l2                     WHERE l2.userid = u.id                       AND l2.contextinstanceid = cm.id                       AND l2.eventname LIKE '%course_module_viewed%'                       AND l2.contextlevel = 70                 ),                 cmc.timemodified             )         ),         '%d/%m/%Y %H:%i:%s'     ) AS "Último Acesso Recurso",      DATE_FORMAT(         FROM_UNIXTIME(             COALESCE(                 cmc.timemodified,                 (                     SELECT MIN(l1.timecreated)                     FROM mdl_logstore_standard_log l1                     WHERE l1.userid = u.id                       AND l1.contextinstanceid = cm.id                       AND l1.eventname LIKE '%course_module_viewed%'                       AND l1.contextlevel = 70                 )             )         ),         '%d/%m/%Y %H:%i:%s'     ) AS "Data Conclusão Moodle",      CASE         WHEN m.name = 'coursecertificate'              AND (cmc.completionstate IS NULL OR cmc.completionstate <> 1)              AND COALESCE(mc.percentual_conclusao, 0) = 100              AND cc.timecompleted IS NOT NULL         THEN 'Curso Concluído (Encaminhado por e-mail)'          WHEN COALESCE(mc.percentual_conclusao, 0) = 100              AND cc.timecompleted IS NOT NULL         THEN 'Curso Concluído'          WHEN COALESCE(mc.percentual_conclusao, 0) = 100         THEN 'Atividades Completas'          WHEN cc.timecompleted IS NOT NULL         THEN 'Curso Concluído (sem todas atividades)'          ELSE 'Atividades Incompletas'     END AS "Status Visualização",      COALESCE(mc.percentual_conclusao, 0) AS "Percentual Conclusão do Recurso",     COALESCE(mc.percentual_conclusao, 0) AS "Progresso Curso"  FROM mdl_user u     INNER JOIN mdl_user_enrolments ue ON ue.userid = u.id     INNER JOIN mdl_enrol e ON e.id = ue.enrolid     INNER JOIN mdl_course c ON c.id = e.courseid     INNER JOIN mdl_course_categories cat ON cat.id = c.category      LEFT JOIN mdl_customfield_field cff_carga            ON cff_carga.shortname = 'carga_horaria'     LEFT JOIN mdl_customfield_data cfd_carga            ON cfd_carga.fieldid = cff_carga.id           AND cfd_carga.instanceid = c.id      INNER JOIN mdl_course_modules cm            ON cm.course = c.id           AND cm.deletioninprogress = 0           AND cm.visible = 1           AND cm.completion > 0      INNER JOIN mdl_modules m            ON m.id = cm.module           AND m.name <> 'label'      LEFT JOIN mdl_course_modules_completion cmc            ON cmc.coursemoduleid = cm.id           AND cmc.userid = u.id      LEFT JOIN mdl_course_completions cc            ON cc.userid = u.id           AND cc.course = c.id      LEFT JOIN (         SELECT             cmc.userid,             cm.course AS courseid,             ROUND(SUM(cmc.completionstate) / COUNT(*) * 100, 2) AS percentual_conclusao         FROM mdl_course_modules_completion cmc             INNER JOIN mdl_course_modules cm ON cm.id = cmc.coursemoduleid         WHERE cm.completion > 0         GROUP BY cmc.userid, cm.course     ) mc ON mc.userid = u.id AND mc.courseid = c.id  WHERE u.deleted = 0   AND u.suspended = 0   AND NOT EXISTS (         SELECT 1         FROM mdl_user_info_data ud             JOIN mdl_user_info_field uf ON uf.id = ud.fieldid         WHERE ud.userid = u.id           AND uf.shortname = 'obs'           AND ud.data = '0'     )  ORDER BY     "Nome Curso",     "Nome Usuário",     "Atividades";
