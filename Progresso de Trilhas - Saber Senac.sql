SELECT DISTINCT     p.id AS "ID da Trilha",     p.fullname AS "Nome da Trilha",     u.id AS "ID do Usuário",     CONCAT(u.firstname, ' ', u.lastname) AS "Nome do Usuário",     c.id AS "ID do Curso",     c.fullname AS "Nome do Curso",      CASE         WHEN cc.timecompleted IS NOT NULL THEN 100         WHEN ue.status = 0 THEN 50         ELSE 0     END AS "Progresso no Curso (%)",      ROUND(AVG(         CASE             WHEN cc.timecompleted IS NOT NULL THEN 100             WHEN ue.status = 0 THEN 50             ELSE 0         END     ) OVER (PARTITION BY p.id, u.id), 2) AS "Progresso na Trilha (%)"  FROM mdl_tool_program p JOIN mdl_tool_program_users pu ON pu.programid = p.id JOIN mdl_user u ON u.id = pu.userid JOIN mdl_tool_program_sets s ON s.programid = p.id JOIN mdl_tool_program_courses pc ON pc.setid = s.id JOIN mdl_course c ON c.id = pc.courseid  LEFT JOIN mdl_enrol e ON e.courseid = c.id LEFT JOIN mdl_user_enrolments ue ON ue.enrolid = e.id AND ue.userid = u.id LEFT JOIN mdl_course_completions cc ON cc.course = c.id AND cc.userid = u.id  WHERE u.deleted = 0  ORDER BY     p.fullname,     u.lastname,     c.fullname;
